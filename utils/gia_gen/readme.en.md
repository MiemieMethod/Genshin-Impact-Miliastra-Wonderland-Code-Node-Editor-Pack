# GIA Node Graph Generator (`gia_gen`)

A TypeScript utility library for creating, editing, and managing Genshin Impact Node Graphs (GIA Node Graph). It provides type-safe, easy-to-use APIs, supporting various system types such as entity node graphs and skill node graphs.

## ‚ú® Features

- üéØ **Type Safety**: Complete TypeScript type definitions, intelligent code completion
- üöÄ **Easy to Use**: Chained calls, intuitive API design
- üîÑ **Bidirectional Conversion**: Supports encoding to Protobuf format and decoding from Protobuf
- üé® **Automatic Layout**: Intelligent node layout algorithm based on Dagre
- üîß **Variant Types**: Full support for type constraints of Variant nodes
- üì¶ **Comprehensive Functionality**: Nodes, connections, comments, and graph variables all included

---

## üì¶ File Structure

| File | Description |
|:-----|:-----|
| [interface.ts](./interface.ts) | **Core API**: Graph and Node class definitions |
| [core.ts](./core.ts) | Low-level encoding/decoding functions |
| [auto_layout.ts](./auto_layout.ts) | Automatic layout algorithm |
| `utils.ts` | Utility functions and counters |
| [example.ts](./example.ts) | Complete usage example |
---

## üöÄ Quick Start

```typescript
import { Graph } from "./utils/gia_gen/interface.ts";
import { NODES } from "./utils/node_data/game_nodes.ts";
import { encode_gia_file } from "./utils/protobuf/decode.ts";

// 1. Create an entity node graph
const graph = new Graph("ENTITY_NODE_GRAPH");

// 2. Add nodes
const trigger = graph.add_node(NODES.Trigger_Tab_OnTabSelect);
const branch = graph.add_node(NODES.Control_General_Branch);

// 3. Connect nodes
graph.flow(trigger, branch);                    // Control flow connection
graph.connect(trigger, branch, "Output0", "cond"); // Data flow connection

// 4. Set pin values
branch.setVal("cases", [1, 2, 3]);

// 5. Automatic layout
graph.autoLayout();

// 6. Save as a .gia file
encode_gia_file("output.gia", graph.encode());
```

---

## üìö Core API

### [Graph](./interface.ts) Class - Node Graph Manager

The core class for node graphs, used to create, manage, and serialize node graphs.

#### Constructor

```typescript
new Graph(
  system_class?: ResourceClass,  // System type, default "ENTITY_NODE_GRAPH"
  uid?: number,                   // User ID, randomly generated by default
  name?: string,                  // Graph name, randomly generated by default
  graph_id?: number              // Graph ID, automatically assigned by default
)
```

**System Type Options**:
- `"ENTITY_NODE_GRAPH"` - Entity Node Graph (default)
- `"SKILL_NODE_GRAPH"` - Skill Node Graph
- `"LEVEL_NODE_GRAPH"` - Level Node Graph
- Other `ResourceClass` types

#### Node Management

```typescript
// Add a node (supports three methods)
add_node(node: string | number | Node, constraints?: NodeType | string): Node | null

// Example
const node1 = graph.add_node("Control.General.Branch");           // Using identifier
const node2 = graph.add_node(NODES.Control_General_Branch);       // Using constant
const node3 = graph.add_node(2);                                  // Using ID
const node4 = graph.add_node(NODES.Arithmetic_General_Equal, "C<T:Int>"); // With constraints
```

#### Connection Management

```typescript
// Control flow connection (determines execution order)
flow(
  from: Node, 
  to: Node, 
  fromArg?: string,    // Source pin identifier (optional)
  toArg?: string,      // Target pin identifier (optional)
  insert_pos?: number  // Insertion position (optional)
): Connection | null

// Data flow connection (transmits data)
connect(
  from: Node, 
  to: Node, 
  fromArg: number | string,  // Source pin: index or identifier
  toArg: number | string     // Target pin: index or identifier
): Connection | null

// Disconnect
disconnect(conn: Connection): void

// Get all connections
get connects(): Connection[]  // All data flow connections
get flows(): Connection[]     // All control flow connections
```

#### Comment Management

```typescript
// Add comments attached to nodes
add_comment(content: string, target_node: Node): Comment | null

// Add independent comments
add_comment(content: string, x: number, y: number): Comment
```

#### Graph Variable Management

```typescript
// Add graph variables (node graph-level global variables)
add_graph_var(
  name: string,
  type: NodeType | string,  // E.g., "Int", "L<Int>", "Bool"
  val?: TypedValue,
  exposed?: boolean         // Whether exposed to external (systems)
): GraphVar | null
```

#### Serialization

```typescript
// Encode to Protobuf format
encode(opt?: any): Gia.AssetBundle

// Decode from Protobuf
static decode(proto: Gia.AssetBundle): Graph
static from(data: Gia.AssetBundle): Graph  // Alias for decode
```

#### Automatic Layout

```typescript
// Automatically calculate node positions
autoLayout(options?: Partial<LayoutOption>): void

// Layout Options
interface LayoutOption {
  node_sep: number;        // Node separation (default 100)
  edge_sep: number;        // Edge separation (default 50)
  rank_sep: number;        // Rank separation (default 300)
  data_pin_height: number; // Data pin height (default 60)
  flow_pin_height: number; // Control flow pin height (default 60)
  pin_width: number;       // Pin width (default 130)
  title_height: number;    // Title height (default 60)
  min_width: number;       // Minimum width (default 200)
  min_height: number;      // Minimum height (default 100)
}
```

#### Debugging

```typescript
// Print debug information
debugPrint({ indent?: number, log?: Function }): void
```

---

### [Node](./interface.ts) Class - Node Instance

Represents a single node in the node graph, containing pin values, connection relationships, and other information.

#### Properties

```typescript
readonly system: ResourceClass;      // Owning system type
readonly node_index: number;         // Node index
readonly def: TypedNodeDef;          // Node definition
variant_def: TypedNodeDef | null;    // Variant type definition
constraint: ConstraintType;          // Type constraint

x: number;                           // X coordinate
y: number;                           // Y coordinate
comment: Comment | null;             // Attached comment
```

#### Pin Operations

```typescript
// Set pin value
setVal(pin: number | string, value: TypedValue): void

// Example
node.setVal("var_name", "Player Level");  // Using identifier
node.setVal(0, 42);                       // Using index
node.setVal(1, [1, 2, 3]);               // Setting list value

// Find pin
findPin(identifier: string): { success: boolean; kind?: "Flow" | "Data"; pin?: TypedPinDef }
findDataPin(identifier: string): TypedPinDef | null
findFlowPin(identifier: string): TypedPinDef | null
getVisibleDataInPin(index: number): TypedPinDef | null
getVisibleDataOutPin(index: number): TypedPinDef | null
```

#### Connection Operations

```typescript
// Connect to another node
connectPinWith(
  pin: string, 
  with_node: Node, 
  with_pin: string, 
  insert_pos?: number
): Connection | null

// Disconnect
disconnectDataInAt(pinIdentifier: string): boolean
disconnectFlowOutAt(pinIdentifier: string, index: number): boolean

// Get all connections
getAllConnections(): Connection[]
```

#### Variant Type Nodes

```typescript
// Set type constraint
setConstraints(constraint: NodeType | string | null): Node

// Example
const equal = graph.add_node(NODES.Arithmetic_General_Equal);
equal.setConstraints("C<T:Int>");  // Set to integer comparison
equal.setConstraints("C<T:Bool>"); // Change to boolean comparison
equal.setConstraints(null);        // Reset to generic

// Automatically resolve constraints
solveConstraints(constraints: [string, NodeType][]): void
```

#### Position and Comments

```typescript
// Set position
setPosition(x: number, y: number, scale_x = 300, scale_y = 200): void

// Add comment
add_comment(content: string): Comment
```

#### Serialization

```typescript
// Encode to Protobuf
encode(): Gia.NodeInstance

// Decode from Protobuf
static decode(system: ResourceClass, proto: Gia.NodeInstance): Node | null
```

#### Debugging

```typescript
// Print node information
debugPrint({ indent?: number, log?: Function }): void
debugPrintPins({ indent?: number, log?: Function }): void
```

---

### Helper Interfaces

#### [Connection](cci:2://file:///d:/Program/GenshinImpact/projs/Convertor/utils/gia_gen/interface.ts:1411:0-1423:1) - Connection

```typescript
interface Connection {
  from: Node;              // Source node
  to: Node;                // Target node
  from_pin: TypedPinDef;   // Source pin
  to_pin: TypedPinDef;     // Target pin
}
```

#### [Comment](cci:2://file:///d:/Program/GenshinImpact/projs/Convertor/utils/gia_gen/interface.ts:1509:0-1518:1) - Comment

```typescript
interface Comment {
  content: string;  // Comment content
  x?: number;       // X coordinate (Independent comment)
  y?: number;       // Y coordinate (Independent comment)
}
```

#### [GraphVar](cci:2://file:///d:/Program/GenshinImpact/projs/Convertor/utils/gia_gen/interface.ts:1535:0-1547:1) - Graph Variable

```typescript
interface GraphVar {
  name: string;      // Variable name
  type: NodeType;    // Variable type
  val: TypedValue;   // Variable value
  exposed: boolean;  // Whether exposed
}
```

---

## üéØ Usage Examples

### Example 1: Create a Simple Trigger-Action Flow

```typescript
const graph = new Graph("ENTITY_NODE_GRAPH");

// Add trigger node
const trigger = graph.add_node("Trigger.Tab.OnTabSelect");

// Add branch node
const branch = graph.add_node("Control.General.Branch");

// Connect control flow
graph.flow(trigger, branch);

// Connect data flow
graph.connect(trigger, branch, "Output0", "cond");

// Set branch condition value
branch.setVal("cond", true);

graph.autoLayout();
encode_gia_file("simple_flow.gia", graph.encode());
```

### Example 2: Use Variant Type Nodes

```typescript
const graph = new Graph("ENTITY_NODE_GRAPH");

// Create variant type nodes (three equivalent ways)
const eq1 = graph.add_node(NODES.Arithmetic_General_Equal)
  .setConstraints("C<T:Int>");

const eq2 = graph.add_node(NODES.Arithmetic_General_Equal, "C<T:Int>");

const eq3 = graph.add_node("Arithmetic.General.Equal.C<T:Int>");

// Set values
eq1.setVal("input1", 10);
eq1.setVal("input2", 20);
```

### Example 3: Use Graph Variables

```typescript
const graph = new Graph("ENTITY_NODE_GRAPH");

// Add graph variables
graph.add_graph_var("playerLevel", "Int", 10, true);
graph.add_graph_var("itemList", "L<Int>", [1, 2, 3], false);

// Node using graph variable
const getVar = graph.add_node("Query.CustomVariable.GetVariable");
getVar.setVal("var_name", "playerLevel");
```

### Example 4: Add Comments

```typescript
const graph = new Graph("ENTITY_NODE_GRAPH");
const node = graph.add_node(NODES.Control_General_Branch);

// Comment attached to node
node.add_comment("This is an important branch node");

// Or add via graph
graph.add_comment("Another comment", node);

// Independent comment
graph.add_comment("This is an independent comment", 600, 100);
```

### Example 5: Load and Modify Existing Graph

```typescript
import { decode_gia_file } from "../protobuf/decode.ts";

// Load existing file
const proto = decode_gia_file("input.gia");
const graph = Graph.decode(proto);

// Modify node
graph.nodes.forEach(node => {
  console.log(`Node: ${node.def.Identifier}`);
});

// Add new node
const newNode = graph.add_node(NODES.Control_General_Branch);

// Save
encode_gia_file("modified.gia", graph.encode());
```

### Example 6: Complex Data Flow

```typescript
const graph = new Graph("ENTITY_NODE_GRAPH");

const trigger = graph.add_node(NODES.Trigger_Tab_OnTabSelect);
const getVar = graph.add_node(NODES.Query_CustomVariable_GetVariable);
const equal = graph.add_node(NODES.Arithmetic_General_Equal, "C<T:Int>");
const branch = graph.add_node(NODES.Control_General_Branch);

// Control flow
graph.flow(trigger, branch);

// Data flow
graph.connect(trigger, getVar, 0, 0);
graph.connect(getVar, equal, 0, "input1");
graph.connect(equal, branch, "result", "cond");

// Set values
getVar.setVal("var_name", "Plant Level");
equal.setVal("input2", 5);

// Automatic layout
graph.autoLayout();
```

---

## üîß Low-level API ([core.ts](./core.ts))

Low-level encoding/decoding functions for advanced users.

### Building Functions

```typescript
// Build graph object
graph_body(body: GraphBody_): Gia.AssetBundle

// Build node object
node_body(body: NodeBody_): Gia.NodeInstance

// Build pin object
pin_body(body: PinBody_): Gia.PinInstance
```

### Value Creation Functions

```typescript
// Create typed value
make_typed_value(type: NodeType, is_server: boolean, val?: TypedValue): Gia.TypedValue

// Create variant type value
make_variant_value(type: NodeType, is_server: boolean, type_index: number, val?: TypedValue): Gia.TypedValue

// Create graph variable
make_graph_variable(type: NodeType, var_name: string, val: TypedValue, exposed: boolean): Gia.GraphVariable

// Basic type values
make_int_value(val: TypedValue, type_def: Gia.TypeDefinition): Gia.TypedValue
make_float_value(val: TypedValue, type_def: Gia.TypeDefinition): Gia.TypedValue
make_string_value(val: TypedValue, type_def: Gia.TypeDefinition): Gia.TypedValue
make_enum_value(val: TypedValue, type_def: Gia.TypeDefinition): Gia.TypedValue
make_vector_value(val: TypedValue, type_def: Gia.TypeDefinition): Gia.TypedValue

// Composite type values
make_list_value(type: ListType, is_server: boolean, val: TypedValue): Gia.TypedValue
make_map_value(type: DictType, is_server: boolean, val: TypedValue): Gia.TypedValue
make_struct_value(type: StructType, is_server: boolean, val: TypedValue): Gia.TypedValue
```

### Decoding Functions

```typescript
// Read typed value
read_typed_value(tv: Gia.TypedValue): TypedValue

// Read graph variable
read_graph_variable(proto: Gia.GraphVariable): { type, name, val, exposed }

// Read connection
read_connections(nc: Gia.NodeConnection): { node_index, kind, shell_index } | null

// Get resource class
get_resource_class(rc: Gia.ResourceEntry_ResourceClass): ResourceClass | null
```

---

## üé® Automatic Layout

Automatically calculates node positions using the Dagre graph layout algorithm.

```typescript
// Using default options
graph.autoLayout();

// Custom layout parameters
graph.autoLayout({
  node_sep: 150,        // Larger node separation
  rank_sep: 400,        // Larger rank separation
  data_pin_height: 80   // Taller pins
});
```

---

## üí° Best Practices

### 1. Use Constants Instead of Strings

```typescript
// ‚úÖ Recommended: Use NODES constants
const node = graph.add_node(NODES.Control_General_Branch);

// ‚ùå Not Recommended: Use strings (prone to typos)
const node = graph.add_node("Control.General.Branch");
```

### 2. Use Identifiers Instead of Indices

```typescript
// ‚úÖ Recommended: Use pin identifiers
graph.connect(nodeA, nodeB, "result", "input");

// ‚ö†Ô∏è Usable but Not Recommended: Use indices
graph.connect(nodeA, nodeB, 0, 0);
```

### 3. Chained Calls

```typescript
// ‚úÖ Recommended: Chained calls
const node = graph.add_node(NODES.Arithmetic_General_Equal)
  .setConstraints("C<T:Int>");

node.setVal("input1", 10)
    .setVal("input2", 20);
```

### 4. Use Automatic Layout

```typescript
// ‚úÖ Recommended: Use automatic layout
graph.autoLayout();

// ‚ö†Ô∏è Manually set position (only when precise control is needed)
node.setPosition(2, 3);
```

---

## üîÑ Migration Guide

If you are using the old API (`graph.ts`), please refer to the following migration guide:

| Old API | New API | Description |
|:-------|:-------|:-----|
| `new Graph("server")` | `new Graph("ENTITY_NODE_GRAPH")` | Use explicit system types |
| `graph.add_node(NODE_ID.xxx)` | `graph.add_node(NODES.xxx)` | Use new node constants |
| `node.setConcrete(id)` | `node.setConstraints("C<T:Type>")` | Use type constraint strings |
| `graph.get_nodes()` | `Array.from(graph.nodes.values())` | Directly access the `nodes` Map |

---

## üìñ Related Documentation

- [Protobuf Tools](../protobuf/readme.en.md) - GIA File Encoding/Decoding
- [Node Data](../node_data/readme.en.md) - Node Definitions and Type System
- [Complete Example](./example.ts) - Practical usage example code

---

## ü§ù Contributing

Contributions via Issues and Pull Requests are welcome!

---

## üìù License

MIT License